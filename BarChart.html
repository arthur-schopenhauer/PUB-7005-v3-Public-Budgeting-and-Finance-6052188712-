<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>County of San Diego Budget — FY 2023–24 to 2025–26 (Enhanced Infographic)</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
  .container { max-width: 1200px; margin: auto; padding: 20px; }
  h1 { text-align: center; }
  .chart-container { position: relative; height: 600px; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  canvas { max-width: 100%; }
  .controls{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 12px}
  .btn{background:#eef3ff; color:#1d2a44; border:1px solid #cdd7f0; border-radius:10px; padding:6px 10px; cursor:pointer}
  .btn[aria-pressed="true"]{background:#dbe6ff; color:#0b1a38}
  .small{font-size:12px; color:#5a6a8a}
</style>
</head>
<body>
<div class="container">
<h1>County of San Diego Budget by Functional Area<br>FY 2023–24, FY 2024–25, FY 2025–26</h1>
<div class="chart-container">
  <div class="controls">
    <div>
      <button id="btnAbs" class="btn" aria-pressed="true">$ Millions</button>
      <button id="btnPct" class="btn" aria-pressed="false">% of Total</button>
      <button id="btnDelta" class="btn" aria-pressed="true">Show Δ line</button>
    </div>
    <label class="small" style="display:flex; align-items:center; gap:8px">
      <input id="chkSort" type="checkbox"> Sort by FY25–26 size
    </label>
  </div>
  <canvas id="budgetChart"></canvas>
  <div class="small" style="margin-top:8px">Tip: toggle between absolute dollars and percent of total; enable the Δ line to see FY25–26 vs FY23 change for each category; sort ranks categories by latest year.</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
Chart.register(ChartDataLabels);

let mode = 'ABS'; // ABS | PCT
let showDelta = true;
let sortByLatest = false;

const baseCategories = [
  'Health & Human Services',
  'Public Safety',
  'Finance & General Government',
  'Land Use & Environment',
  'Finance Other',
  'Capital Program'
];
const raw = {
  FY23: [3195.4, 2687.9, 889.6, 674.4, 459.7, 258.9],
  FY24: [3179.9, 2595.2, 857.9, 648.3, 360.7, 8.9],
  FY26: [3343.0, 2738.1, 925.2, 685.6, 383.4, 8.8]
};

function totals(arr){ return arr.reduce((a,b)=>a+b,0); }
const total23 = totals(raw.FY23), total24 = totals(raw.FY24), total26 = totals(raw.FY26);

function toPercent(values, total){ return values.map(v => v/total*100); }

function currentOrder(){
  const order = baseCategories.map((_,i)=>i);
  if(sortByLatest){
    return order.sort((a,b)=> raw.FY26[b] - raw.FY26[a]);
  }
  return order;
}

function buildDatasets(order){
  const FY23 = order.map(i=> raw.FY23[i]);
  const FY24 = order.map(i=> raw.FY24[i]);
  const FY26 = order.map(i=> raw.FY26[i]);
  const labels = order.map(i=> baseCategories[i]);

  let yTitle = 'Appropriations (Millions USD)';
  let dFY23 = FY23, dFY24 = FY24, dFY26 = FY26, useRightAxis = true;

  if(mode==='PCT'){
    yTitle = '% of Total';
    dFY23 = toPercent(FY23, total23);
    dFY24 = toPercent(FY24, total24);
    dFY26 = toPercent(FY26, total26);
    useRightAxis = false;
  }

  const delta = FY26.map((v,i)=> v - FY23[i]);
  const datasets = [
    { label:'FY 2023–24', data:dFY23, backgroundColor:'rgba(54,162,235,0.7)', stack:'grp' },
    { label:'FY 2024–25', data:dFY24, backgroundColor:'rgba(75,192,192,0.7)', stack:'grp' },
    { label:'FY 2025–26', data:dFY26, backgroundColor:'rgba(255,206,86,0.8)', stack:'grp' }
  ];
  if(showDelta){
    datasets.push({ label:'Δ FY26 vs FY23', data: mode==='PCT' ? toPercent(delta, total26) : delta, type:'line', yAxisID: useRightAxis ? 'y1':'y', borderColor:'rgba(255,99,132,0.9)', backgroundColor:'rgba(255,99,132,0.15)', tension:0.2, pointRadius:3 });
  }

  return { labels, datasets, yTitle };
}

let chart;
function render(){
  const order = currentOrder();
  const cfg = buildDatasets(order);
  const ctx = document.getElementById('budgetChart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'bar',
    data:{ labels: cfg.labels, datasets: cfg.datasets },
    options:{
      responsive:true,
      interaction:{ mode:'index', intersect:false },
      scales:{
        y:{ beginAtZero:true, max: mode==='PCT'? 100: undefined, title:{ display:true, text: cfg.yTitle } },
        y1:{ beginAtZero:true, display: showDelta && mode==='ABS', position:'right', grid:{ drawOnChartArea:false }, title:{ display: showDelta && mode==='ABS', text:'Change vs FY23 (Millions)' } }
      },
      plugins:{
        legend:{ position:'top' },
        tooltip:{
          callbacks:{
            label(ctx){
              const rawVal = (ctx.dataset.type==='line')? ctx.parsed.y : (mode==='PCT'? (ctx.raw) : ctx.raw);
              if(mode==='PCT'){
                return `${ctx.dataset.label}: ${Number(rawVal).toFixed(1)}%`;
              }
              const val = Number(rawVal).toLocaleString(undefined,{maximumFractionDigits:1});
              return `${ctx.dataset.label}: $${val} M`;
            },
            afterBody(ctx){
              // Show share of FY25–26 in ABS mode
              const i = ctx[0].dataIndex;
              if(mode==='ABS'){
                const share = raw.FY26[i]/total26*100;
                return `FY25–26 share: ${share.toFixed(1)}%`;
              }
            }
          }
        },
        datalabels:{
          anchor:'end', align:'end', clamp:true, formatter:(v,ctx)=>{
            if(ctx.dataset.type==='line') return ''; // keep line uncluttered
            return mode==='PCT' ? `${v.toFixed(1)}%` : `${Number(v).toFixed(0)}`;
          }, font:{size:10}
        }
      }
    }
  });
}

// controls
const btnAbs = document.getElementById('btnAbs');
const btnPct = document.getElementById('btnPct');
const btnDelta = document.getElementById('btnDelta');
const chkSort = document.getElementById('chkSort');

btnAbs.onclick = ()=>{ mode='ABS'; btnAbs.setAttribute('aria-pressed','true'); btnPct.setAttribute('aria-pressed','false'); render(); };
btnPct.onclick = ()=>{ mode='PCT'; btnPct.setAttribute('aria-pressed','true'); btnAbs.setAttribute('aria-pressed','false'); render(); };
btnDelta.onclick = ()=>{ showDelta=!showDelta; btnDelta.setAttribute('aria-pressed', String(showDelta)); render(); };
chkSort.onchange = (e)=>{ sortByLatest = e.target.checked; render(); };

render();
</script>
</body>
</html>
